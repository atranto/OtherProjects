---
title: "Chapter 3: Exponential Smoothing"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Moving Average and Simple Exponential Smoothing}

It often makes sense to look at data on a log scale.
```{r}
library(tseries)
#load data contained in "tsa3.rda"
load("/home/alekthiery/Dropbox/teaching/ST3233_2018/dataset/tsa3.rda")
#load("/Users/alex/Dropbox/teaching/ST3233_2018/dataset/tsa3.rda")

#solar spots time series
plot(sunspots, type="l", ylab="Sun Spots", main="Sun Spots")

#zoom:: plot only from year 1970 onward
SS = window(sunspots, start=1970)
plot(SS, type="l", ylab="Sun Spots", main="Sun Spots: 1970 onward")
```


Basic forecasting with a moving average.
```{r}
weights3 = rep(1,3) / 3
SSMA3 = filter(lag(SS, k=-1), filter = weights3, sides=1)

weights10 = rep(1,10) / 10
SSMA10 = filter(lag(SS, k=-1), filter = weights10, sides=1)

plot(SS, type="l", ylab="Sun Spots", main="MA(3)")
lines(SSMA3, col="red", lwd=2)

plot(SS, type="l", ylab="Sun Spots", main="MA(10)")
lines(SSMA10, col="red", lwd=2)
```

Let us look at the root mean squared error (RMSE) as a function of the order of the moving average.
```{r}
rmse_ma = function(ma_order, time_series){
  weights = rep(1,ma_order) / ma_order
  prediction = filter(lag(time_series, k=-1), filter = weights, sides=1)
  return( sqrt(mean(na.remove(time_series - prediction)**2)) )
}


rmse_list = rep(0,10)
for(k in 1:10){
  rmse_list[k] = rmse_ma(k,SS)
}
plot(1:10, rmse_list, main="Root Mean Squared Error",
     xlab="MA order", ylab="RMSE", type="b")
```

Let us now look at the Simple Exponential Smoothing (SES) approach.
```{r}
suppressMessages(library(fpp))
fit1 <- ses(SS, alpha=0.2, initial="simple", h=50)
fit2 <- ses(SS, alpha=0.8, initial="simple", h=50)
fit_optim <- ses(SS, h=50) #optimal

plot(SS, ylab="Sun Spots",
  xlab="Year", main="SES: alpha=0.2", type="l",)
lines(fitted(fit1), col="blue", type="l")

plot(SS, ylab="Sun Spots",
  xlab="Year", main="SES: alpha=0.8", type="l")
lines(fitted(fit2), col="red", type="l")

plot(SS, ylab="Sun Spots",
  xlab="Year", main="SES: optimal", type="l")
lines(fitted(fit_optim), col="green", type="l")

plot(SS, ylab="Sun Spots",
  xlab="Year", main="Forecasts", type="l", xlim=c(1970,1990))
lines(fit1$mean, col="blue", type="l",lwd=3)
lines(fit2$mean, col="red", type="l", lwd=3)
lines(fit_optim$mean, col="green", type="l", lwd=3)
```

Again, let us look at the Root Mean Square Error (RMSE) as a function of the parameter $\alpha$
```{r}
rmse_SES = function(alpha, time_series){
  prediction = fitted(ses(time_series, alpha=alpha, initial="simple", h=1))
  return( sqrt(mean(na.remove(time_series - prediction)**2)) )
}

alpha_list = seq(from=0.05, to=0.95, by=0.05)
rmse_list = rep(0,length(alpha_list))
for(k in 1:length(alpha_list)){
  rmse_list[k] = rmse_SES(alpha_list[k], SS)
}
plot(alpha_list, rmse_list, main="Root Mean Squared Error",
     xlab="alpha", ylab="MSE", type="l")

#plot where the minimum occurs
index_min = which.min(rmse_list)
points(alpha_list[index_min], rmse_list[index_min], pch=20)

#let us see if the optimal model is close to what we found
print(fit_optim$model$par)
```


# Holt's algorithm: linear trend

Let us look again at the Sunspots time series and use the Holt's algorithm to do some forecasting.

```{r}
fit1 <- holt(SS, alpha=0.8, beta=0.8, initial="simple", h=50) 
fit2 <- holt(SS, alpha=0.4, beta=0.03, initial="simple", h=50) 
fit_optim <- holt(SS, initial="optimal", h=50) 


print("optimal model::")
print(fit_optim$model$par)

plot(SS, ylab="Sun Spots",
  xlab="Year", main="Holt: alpha=0.8, beta=0.8", type="l",)
lines(fitted(fit1), col="blue", type="l")

plot(SS, ylab="Sun Spots",
  xlab="Year", main="Holt: alpha=0.2, beta=0.2", type="l",)
lines(fitted(fit2), col="red", type="l")

plot(SS, ylab="Sun Spots",
  xlab="Year", main="Holt: optimal", type="l",)
lines(fitted(fit_optim), col="green", type="l")

plot(SS, ylab="Sun Spots", xlab="Year", main="Forecasts", 
     type="l", xlim=c(1970,1990), ylim=c(-100,200))
lines(fit1$mean, col="blue", type="l",lwd=2)
lines(fit2$mean, col="red", type="l", lwd=2)
lines(fit_optim$mean, col="green", type="l", lwd=2)
```


# Holt-Winters' algorithm: trend + seasonal pattern

```{r}
plot(flu, main="Flu")

#use a log scale
logflu = log(flu)
plot(logflu, main="Log Flu")

#fit a double exponential model
fit_holt <- holt(logflu, initial="optim",h=50) 
fit_hw <- hw(logflu, initial="optim", seasonal="additive",h=50) 

#double exponential model:: plot the forecast: point estimate
plot(logflu, ylab="Flu", xlim=c(1968, 1985),ylim=c(-3,2),
  xlab="Year", main="Holt: optimal", type="l",lw=3)
lines(fitted(fit_holt), col="green", type="l")
lines(fit_holt$mean, col="blue", type="l",lwd=2)

#plot the forecast: confidence interval
plot(fit_holt, lw=3, ylim=c(-3,2),xlim=c(1968, 1985))

#fit a triple exponential model
plot(logflu, ylab="Sun Spots", xlim=c(1968, 1985),ylim=c(-3,2),
  xlab="Year", main="Holt-Winters: optimal", type="l",lw=3)
lines(fitted(fit_hw), col="green", type="l")
lines(fit_hw$mean, col="blue", type="l",lwd=2)

#triple exponential model:: plot the forecast: point estimate
plot(fit_hw, lw=3, ylim=c(-3,2),xlim=c(1968, 1985))

#triple exponential model:: estimated trend/season
plot( fit_hw$model )
```



